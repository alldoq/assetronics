#!/bin/bash
set -e

# ==============================================================================
# REMOTE DEPLOYMENT CONFIGURATION
# ==============================================================================

# SSH Configuration
REMOTE_HOST="${REMOTE_HOST:-your-server.com}"
REMOTE_USER="${REMOTE_USER:-deploy}"
REMOTE_PORT="${REMOTE_PORT:-22}"

# Deployment Configuration
REPO_URL="${REPO_URL:-git@github.com:user/assetronics.git}"
BRANCH="${BRANCH:-main}"
DEPLOY_PATH="${DEPLOY_PATH:-/var/www/assetronics}"
MIX_ENV="${MIX_ENV:-prod}"
KEEP_RELEASES="${KEEP_RELEASES:-5}"
APP_PORT="${APP_PORT:-4000}"
DOMAIN="${DOMAIN:-assetronics.com}"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

# ==============================================================================
# MAIN
# ==============================================================================

SSH_CMD="ssh -p ${REMOTE_PORT} ${REMOTE_USER}@${REMOTE_HOST}"
SCP_CMD="scp -P ${REMOTE_PORT}"

ACTION="${1:-deploy}"

log_info "Connecting to ${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_PORT}"

# Copy deployment script to remote server
log_info "Copying deployment script to remote server..."

# Retry SCP up to 3 times with delays
max_retries=3
retry_count=0
while [ $retry_count -lt $max_retries ]; do
    if ${SCP_CMD} "$(dirname "$0")/deploy" "${REMOTE_USER}@${REMOTE_HOST}:/tmp/deploy" 2>/dev/null; then
        break
    else
        retry_count=$((retry_count + 1))
        if [ $retry_count -lt $max_retries ]; then
            log_warn "SCP failed, retrying in 2 seconds... (attempt $retry_count/$max_retries)"
            sleep 2
        else
            log_warn "SCP failed after $max_retries attempts, trying alternative method..."
            # Alternative: use SSH with cat
            ${SSH_CMD} "cat > /tmp/deploy" < "$(dirname "$0")/deploy"
        fi
    fi
done

# Execute deployment on remote server
log_info "Executing ${ACTION} on remote server..."
${SSH_CMD} "
    chmod +x /tmp/deploy
    REPO_URL='${REPO_URL}' \
    BRANCH='${BRANCH}' \
    DEPLOY_PATH='${DEPLOY_PATH}' \
    MIX_ENV='${MIX_ENV}' \
    KEEP_RELEASES='${KEEP_RELEASES}' \
    PORT='${APP_PORT}' \
    DOMAIN='${DOMAIN}' \
    /tmp/deploy ${ACTION}
"

log_info "Remote deployment completed!"
