#!/bin/bash
# Fix .env file on remote server

export REMOTE_HOST="192.168.1.139"
export REMOTE_USER="marcin"
export REMOTE_PORT="22"
export DEPLOY_PATH="/home/marcin/assetronics"

SSH_CMD="ssh -p ${REMOTE_PORT} ${REMOTE_USER}@${REMOTE_HOST}"

echo "[INFO] Fixing .env file on ${REMOTE_USER}@${REMOTE_HOST}"

# Generate a random secret key base
SECRET_KEY=$(openssl rand -base64 64 | tr -d '\n')
RELEASE_COOKIE=$(openssl rand -hex 32)
CLOAK_KEY=$(openssl rand -base64 32 | tr -d '\n')

echo "[INFO] Creating proper .env file..."

${SSH_CMD} "cat > ${DEPLOY_PATH}/shared/.env << 'EOF'
DATABASE_URL=ecto://postgres:postgres@localhost:5433/assetronics_prod
SECRET_KEY_BASE=${SECRET_KEY}
RELEASE_COOKIE=${RELEASE_COOKIE}
CLOAK_KEY=${CLOAK_KEY}
PHX_HOST=localhost
PORT=4025
PHX_SERVER=true
MIX_ENV=prod
EOF"

echo "[INFO] .env file created successfully"
echo ""
echo "IMPORTANT: Edit the DATABASE_URL with your actual database credentials:"
echo "  ssh ${REMOTE_USER}@${REMOTE_HOST}"
echo "  nano ${DEPLOY_PATH}/shared/.env"
echo ""
echo "Current .env contents:"
${SSH_CMD} "cat ${DEPLOY_PATH}/shared/.env"
