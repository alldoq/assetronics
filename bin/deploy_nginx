#!/bin/bash
# Deploy nginx configuration

export REMOTE_HOST="192.168.1.139"
export REMOTE_USER="marcin"
export REMOTE_PORT="22"

SSH_CMD="ssh -p ${REMOTE_PORT} ${REMOTE_USER}@${REMOTE_HOST}"
SCP_CMD="scp -P ${REMOTE_PORT}"

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_info "Deploying nginx configuration for assetronics..."

# Copy nginx config to remote server
log_info "Copying nginx config to remote server..."
${SCP_CMD} "$(dirname "$0")/../config/nginx/assetronics" "${REMOTE_USER}@${REMOTE_HOST}:/tmp/assetronics.conf" 2>/dev/null || \
    ${SSH_CMD} "cat > /tmp/assetronics.conf" < "$(dirname "$0")/../config/nginx/assetronics"

# Deploy and activate nginx config
log_info "Installing nginx configuration..."
${SSH_CMD} "
    # Backup existing config if it exists
    if [ -f /etc/nginx/sites-available/assetronics ]; then
        sudo cp /etc/nginx/sites-available/assetronics /etc/nginx/sites-available/assetronics.backup.\$(date +%Y%m%d_%H%M%S)
    fi

    # Copy new config
    sudo cp /tmp/assetronics.conf /etc/nginx/sites-available/assetronics

    # Enable site (create symlink if it doesn't exist)
    if [ ! -L /etc/nginx/sites-enabled/assetronics ]; then
        sudo ln -s /etc/nginx/sites-available/assetronics /etc/nginx/sites-enabled/assetronics
    fi

    # Test nginx configuration
    echo '[INFO] Testing nginx configuration...'
    if sudo nginx -t; then
        echo '[INFO] Nginx configuration is valid'

        # Reload nginx
        echo '[INFO] Reloading nginx...'
        if sudo systemctl reload nginx; then
            echo '[INFO] Nginx reloaded successfully'
        else
            echo '[ERROR] Failed to reload nginx, trying restart...'
            sudo systemctl restart nginx
        fi

        # Show nginx status
        echo ''
        echo '[INFO] Nginx status:'
        sudo systemctl status nginx --no-pager -l
    else
        echo '[ERROR] Nginx configuration test failed'
        echo '[ERROR] Restoring backup...'
        if [ -f /etc/nginx/sites-available/assetronics.backup.* ]; then
            sudo cp \$(ls -t /etc/nginx/sites-available/assetronics.backup.* | head -1) /etc/nginx/sites-available/assetronics
        fi
        exit 1
    fi
"

if [ $? -eq 0 ]; then
    log_info "Nginx configuration deployed successfully!"
    echo ""
    log_info "Your site is now configured for:"
    log_info "  - http://assetronics.com (landing page)"
    log_info "  - http://www.assetronics.com (landing page)"
    log_info "  - http://app.assetronics.com (application)"
    echo ""
    log_warn "To enable HTTPS, run certbot on the server:"
    log_warn "  ssh ${REMOTE_USER}@${REMOTE_HOST}"
    log_warn "  sudo certbot --nginx -d assetronics.com -d www.assetronics.com -d app.assetronics.com"
else
    log_error "Nginx configuration deployment failed"
    exit 1
fi
